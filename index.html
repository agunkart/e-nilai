<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi E-Nilai (Mobile-Friendly)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Library untuk membaca file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library untuk membuat PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .editable { cursor: pointer; transition: background-color 0.3s; }
        td[contenteditable="true"] { min-width: 60px; }
        th, td { white-space: nowrap; padding: 10px 14px; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .page { display: none; }
        .page.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .nilai-merah { color: #dc2626; font-weight: bold; }
        .semester-tab {
            cursor: pointer;
            padding: 8px 16px;
            border-bottom: 2px solid transparent;
        }
        .semester-tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        
        /* --- Mobile-First Styles --- */
        .desktop-nav { display: none; }
        .mobile-header, .mobile-bottom-nav { display: flex; }
        .mobile-menu { display: none; }
        .mobile-menu.open { display: block; }

        @media (min-width: 768px) {
            .desktop-nav { display: flex; }
            .mobile-header, .mobile-bottom-nav { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Halaman Login -->
    <div id="login-container" class="flex items-center justify-center h-screen bg-gray-200 p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <div class="text-center mb-8">
                <i class="fas fa-book-reader text-5xl text-blue-600"></i>
                <h1 class="text-3xl font-bold text-gray-800 mt-4">E-Nilai Login</h1>
                <p class="text-gray-500">Silakan masuk untuk melanjutkan</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center hidden">Username atau password salah!</p>
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Masuk</button>
                <p class="text-center text-sm mt-4"><a href="#" id="reset-password-link" class="font-medium text-blue-600 hover:text-blue-800">Lupa Password?</a></p>
                <p class="text-center text-sm text-gray-600 mt-6">
                    Informasi dan Saran gabung ke 
                    <a href="https://chat.whatsapp.com/LvzbnBgTffKCGUIStyayh5" target="_blank" class="font-medium text-green-600 hover:text-green-800">
                        <i class="fab fa-whatsapp"></i> WA Group
                    </a>
                </p>
                <p class="text-center text-xs text-gray-500 pt-2">Pengembang: Agung Kurniawan, S.Pd.</p>
            </div>
        </div>
    </div>

    <!-- Kontainer Aplikasi Utama -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen bg-gray-200">
            <!-- Sidebar Navigasi (Desktop) -->
            <aside class="desktop-nav w-64 bg-gray-800 text-white flex-shrink-0 flex-col">
                <div class="p-6 text-2xl font-bold border-b border-gray-700">
                    <i class="fas fa-book-reader mr-2"></i> E-Nilai
                </div>
                <nav class="mt-6 flex-grow">
                    <a href="#" class="nav-link flex items-center py-3 px-6 hover:bg-gray-700" data-page="data-sekolah">
                        <i class="fas fa-school w-6 mr-3"></i> Data Sekolah
                    </a>
                    <a href="#" class="nav-link flex items-center py-3 px-6 hover:bg-gray-700" data-page="data-siswa">
                        <i class="fas fa-users w-6 mr-3"></i> Data Siswa
                    </a>
                    <a href="#" class="nav-link flex items-center py-3 px-6 hover:bg-gray-700" data-page="olah-nilai">
                        <i class="fas fa-edit w-6 mr-3"></i> Olah Nilai
                    </a>
                    <a href="#" class="nav-link flex items-center py-3 px-6 hover:bg-gray-700" data-page="rekap-nilai">
                        <i class="fas fa-chart-bar w-6 mr-3"></i> Rekap Nilai
                    </a>
                    <a href="#" class="nav-link flex items-center py-3 px-6 hover:bg-gray-700" data-page="pengaturan">
                        <i class="fas fa-user-cog w-6 mr-3"></i> Pengaturan
                    </a>
                </nav>
                <div class="p-4 border-t border-gray-700">
                    <a href="https://chat.whatsapp.com/LvzbnBgTffKCGUIStyayh5" target="_blank" class="w-full flex items-center justify-center py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 mb-4 transition-colors">
                         <i class="fab fa-whatsapp mr-2"></i> Grup WA
                    </a>
                    <button id="logout-btn" class="w-full flex items-center justify-center py-2 px-4 bg-red-600 hover:bg-red-700 rounded-lg">
                        <i class="fas fa-sign-out-alt mr-2"></i> Keluar
                    </button>
                </div>
            </aside>

            <!-- Konten Utama -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <!-- Header (Mobile) -->
                <header class="mobile-header bg-white shadow-md p-4 justify-between items-center relative">
                    <h1 id="page-title" class="text-xl font-bold text-gray-800">Data Sekolah</h1>
                    <button id="mobile-menu-btn" class="text-gray-600 text-2xl">
                        <i class="fas fa-bars"></i>
                    </button>
                    <!-- Mobile Menu Dropdown -->
                    <div id="mobile-menu-dropdown" class="mobile-menu absolute top-full right-4 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                        <a href="#" class="nav-link block px-4 py-2 text-gray-700 hover:bg-gray-100" data-page="pengaturan"><i class="fas fa-user-cog w-6 mr-2"></i>Pengaturan</a>
                        <a href="https://chat.whatsapp.com/LvzbnBgTffKCGUIStyayh5" target="_blank" class="block px-4 py-2 text-gray-700 hover:bg-gray-100"><i class="fab fa-whatsapp w-6 mr-2 text-green-500"></i>Grup WA</a>
                        <div class="border-t my-1"></div>
                        <a href="#" id="logout-btn-mobile" class="block px-4 py-2 text-red-600 hover:bg-gray-100"><i class="fas fa-sign-out-alt w-6 mr-2"></i>Keluar</a>
                    </div>
                </header>
                
                <!-- Area Konten dengan Padding (untuk menghindari overlap dengan nav bawah) -->
                <div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 pb-24">
                    
                    <!-- Halaman 1: Data Sekolah -->
                    <div id="page-data-sekolah" class="page">
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Informasi Institusi</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                                        <input type="text" id="school-name" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Sekolah</label>
                                        <input type="text" id="school-address" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label>
                                        <input type="text" id="tahun-ajaran" placeholder="Contoh: 2024/2025" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Penanggung Jawab</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Kepala Sekolah</label>
                                        <input type="text" id="ks-name" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">NIP Kepala Sekolah</label>
                                        <input type="text" id="ks-nip" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Guru</label>
                                        <input type="text" id="teacher-name" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">NIP Guru</label>
                                        <input type="text" id="teacher-nip" class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                 <button id="save-school-data" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                                    <i class="fas fa-save mr-2"></i>Simpan Data
                                 </button>
                            </div>
                        </div>
                    </div>

                    <!-- Halaman 2: Data Siswa -->
                    <div id="page-data-siswa" class="page">
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-md flex flex-col">
                                <h3 class="text-lg font-semibold mb-4">Tambah Siswa</h3>
                                <div class="space-y-3 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">NIS</label>
                                        <input type="text" id="new-student-nis" placeholder="Nomor Induk Siswa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                        <input type="text" id="new-student-name" placeholder="Ketik nama siswa..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Kelas</label>
                                        <input type="text" id="new-student-class" placeholder="Contoh: IV-A" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                                        <div class="mt-1 flex gap-4">
                                            <label class="inline-flex items-center"><input type="radio" name="new-student-gender" value="L" class="form-radio" checked> <span class="ml-2">Laki-laki</span></label>
                                            <label class="inline-flex items-center"><input type="radio" name="new-student-gender" value="P" class="form-radio"> <span class="ml-2">Perempuan</span></label>
                                        </div>
                                    </div>
                                    <button id="add-student-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg !mt-4">Tambah Siswa</button>
                                </div>
                                <div class="border-t pt-4 mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Unggah dari File</label>
                                    <input type="file" id="upload-excel" accept=".xlsx, .xls">
                                    <label for="upload-excel" class="w-full cursor-pointer bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-file-excel mr-2"></i> Pilih File .xlsx
                                    </label>
                                    <p class="text-xs text-gray-500 mt-2">Format: Kolom A: NIS, B: Nama, C: Kelas, D: Jenis Kelamin (L/P).</p>
                                </div>
                            </div>
                            <div class="bg-white p-4 md:p-6 rounded-xl shadow-md">
                                 <h3 class="text-lg font-semibold mb-4">Daftar Siswa</h3>
                                 <div class="table-container overflow-x-auto">
                                    <table id="student-list-table" class="w-full text-sm text-left text-gray-700"></table>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Halaman 3: Olah Nilai -->
                    <div id="page-olah-nilai" class="page">
                         <div class="flex border-b mb-4">
                            <div class="semester-tab flex-1 text-center" data-semester="semester1">Semester 1</div>
                            <div class="semester-tab flex-1 text-center" data-semester="semester2">Semester 2</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div class="w-full md:w-auto flex-grow">
                                    <label for="subject-selector" class="block text-sm font-medium text-gray-700 mb-1">Mata Pelajaran:</label>
                                    <select id="subject-selector" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5"></select>
                                </div>
                                <div class="w-full md:w-auto flex gap-2">
                                    <div class="flex-grow">
                                        <label for="kkm-input" class="block text-sm font-medium text-gray-700 mb-1">KKM:</label>
                                        <input type="number" id="kkm-input" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5">
                                    </div>
                                    <button id="edit-subjects-btn" class="self-end bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div id="table-container" class="table-container overflow-x-auto">
                                <table id="grades-table" class="w-full text-sm text-left text-gray-700">
                                    <thead class="text-xs text-gray-800 uppercase"></thead>
                                    <tbody class="bg-white"></tbody>
                                </table>
                            </div>
                            <div class="p-4 bg-gray-50 border-t grid grid-cols-2 gap-2">
                                <button id="add-summative-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded-lg text-xs">+ AS</button>
                                <button id="delete-summative-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg text-xs">- AS</button>
                            </div>
                             <div class="p-2 text-center bg-gray-50 text-xs text-gray-600 border-t">
                                Keterangan: <strong>AS</strong> = Asesmen Sumatif
                            </div>
                        </div>
                    </div>

                    <!-- Halaman 4: Rekap Nilai -->
                    <div id="page-rekap-nilai" class="page">
                        <div class="flex border-b mb-4">
                            <div class="semester-tab flex-1 text-center" data-semester="semester1">Semester 1</div>
                            <div class="semester-tab flex-1 text-center" data-semester="semester2">Semester 2</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-6 space-y-4">
                            <div>
                                <label for="lokasi-cetak" class="block text-sm font-medium text-gray-700">Lokasi Cetak</label>
                                <input type="text" id="lokasi-cetak" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="tanggal-cetak" class="block text-sm font-medium text-gray-700">Tanggal Cetak</label>
                                <input type="text" id="tanggal-cetak" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                             <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                                <button id="preview-pdf-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                                    <i class="fas fa-eye mr-2"></i> Pratinjau
                                </button>
                                <button id="download-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                                    <i class="fas fa-download mr-2"></i> PDF
                                </button>
                                <button id="download-excel-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                                    <i class="fas fa-file-excel mr-2"></i> XLSX
                                </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div class="table-container overflow-x-auto">
                                <table id="recap-table" class="w-full text-sm text-left text-gray-700"></table>
                            </div>
                        </div>
                    </div>

                    <!-- Halaman 5: Pengaturan -->
                    <div id="page-pengaturan" class="page">
                        <div class="bg-white p-6 rounded-xl shadow-md max-w-lg mx-auto">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">Ubah Akun</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="current-password" class="block text-sm font-medium text-gray-700">Password Saat Ini</label>
                                    <input type="password" id="current-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                                </div>
                                <div>
                                    <label for="new-username" class="block text-sm font-medium text-gray-700">Username Baru</label>
                                    <input type="text" id="new-username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </div>
                                <div>
                                    <label for="new-password" class="block text-sm font-medium text-gray-700">Password Baru</label>
                                    <input type="password" id="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </div>
                                <p id="settings-message" class="text-sm text-center"></p>
                                <button id="save-settings-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Simpan Perubahan</button>
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- Navigasi Bawah (Mobile) -->
                <nav class="mobile-bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.1)] justify-around z-10">
                    <a href="#" class="nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600" data-page="data-sekolah">
                        <i class="fas fa-school text-xl"></i>
                        <span class="text-xs mt-1">Sekolah</span>
                    </a>
                    <a href="#" class="nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600" data-page="data-siswa">
                        <i class="fas fa-users text-xl"></i>
                        <span class="text-xs mt-1">Siswa</span>
                    </a>
                    <a href="#" class="nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600" data-page="olah-nilai">
                        <i class="fas fa-edit text-xl"></i>
                        <span class="text-xs mt-1">Nilai</span>
                    </a>
                    <a href="#" class="nav-link flex-1 flex flex-col items-center justify-center p-2 text-gray-600" data-page="rekap-nilai">
                        <i class="fas fa-chart-bar text-xl"></i>
                        <span class="text-xs mt-1">Rekap</span>
                    </a>
                </nav>
            </main>
        </div>
    </div>

    <!-- Semua Modal -->
    <div id="delete-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900">Konfirmasi Hapus</h3>
            <p class="my-4 text-gray-700">Apakah Anda yakin ingin menghapus siswa <strong id="delete-student-name" class="text-red-600"></strong>?</p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 transition-colors">Batal</button>
                <button id="confirm-delete-btn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 transition-colors">Hapus</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-bold text-gray-900">Edit Data Siswa</h3>
            <div class="my-4 space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700">NIS (Tidak dapat diubah)</label>
                    <input type="text" id="edit-student-nis" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100" readonly>
                </div>
                <div>
                    <label for="edit-student-name" class="block text-sm font-medium text-gray-700">Nama Baru</label>
                    <input type="text" id="edit-student-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="edit-student-class" class="block text-sm font-medium text-gray-700">Kelas</label>
                    <input type="text" id="edit-student-class" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                    <div class="mt-1 flex gap-4">
                        <label class="inline-flex items-center"><input type="radio" name="edit-student-gender" value="L" class="form-radio"> <span class="ml-2">Laki-laki</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="edit-student-gender" value="P" class="form-radio"> <span class="ml-2">Perempuan</span></label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-edit-btn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
                <button id="save-edit-btn" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>
    <div id="subjects-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Kelola Mata Pelajaran</h3>
            <div class="max-h-64 overflow-y-auto border rounded-lg p-4">
                <ul id="subjects-list" class="space-y-2"></ul>
            </div>
            <div class="mt-4 border-t pt-4">
                <h4 class="text-md font-semibold mb-2">Tambah Mapel Baru</h4>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="new-subject-name" placeholder="Nama mata pelajaran..." class="flex-grow block w-full rounded-md border-gray-300 shadow-sm p-2">
                    <input type="number" id="new-subject-kkm" placeholder="KKM" class="w-full sm:w-24 block rounded-md border-gray-300 shadow-sm p-2">
                    <button id="add-subject-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Tambah</button>
                </div>
            </div>
            <div class="text-right mt-6">
                <button id="close-subjects-modal-btn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Tutup</button>
            </div>
        </div>
    </div>
    <div id="edit-subject-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-bold text-gray-900">Edit Mata Pelajaran</h3>
            <div class="my-4 space-y-3">
                 <div>
                    <label for="edit-subject-input" class="block text-sm font-medium text-gray-700">Nama Baru</label>
                    <input type="text" id="edit-subject-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                 <div>
                    <label for="edit-subject-kkm" class="block text-sm font-medium text-gray-700">KKM</label>
                    <input type="number" id="edit-subject-kkm" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-edit-subject-btn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
                <button id="save-edit-subject-btn" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Simpan</button>
            </div>
        </div>
    </div>
    <div id="delete-subject-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900">Konfirmasi Hapus</h3>
            <p class="my-4 text-gray-700">Yakin ingin menghapus mata pelajaran <strong id="delete-subject-name" class="text-red-600"></strong>? Semua nilai terkait akan hilang.</p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-delete-subject-btn" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
                <button id="confirm-delete-subject-btn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Hapus</button>
            </div>
        </div>
    </div>


    <script>
        // --- LOGIN SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');
            const resetPasswordLink = document.getElementById('reset-password-link');

            let credentials = { username: 'admin', password: '12345' };
            const savedStateJSON = localStorage.getItem('nilaiSiswaState');
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);
                if (savedState.credentials) {
                    credentials = savedState.credentials;
                }
            }

            const attemptLogin = () => {
                if (usernameInput.value === credentials.username && passwordInput.value === credentials.password) {
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    loginError.classList.add('hidden');
                    initializeApp(); // Initialize the main app after successful login
                } else {
                    loginError.classList.remove('hidden');
                }
            };

            resetPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                const masterKey = prompt("Masukkan kode pemulihan untuk mereset password:");
                if (masterKey === 'reset123') {
                    const currentStateJSON = localStorage.getItem('nilaiSiswaState');
                    let currentState = currentStateJSON ? JSON.parse(currentStateJSON) : {};
                    currentState.credentials = { username: 'admin', password: '12345' };
                    localStorage.setItem('nilaiSiswaState', JSON.stringify(currentState));
                    alert("Password berhasil direset ke '12345'. Silakan muat ulang halaman dan coba login kembali.");
                    window.location.reload();
                } else if (masterKey !== null) {
                    alert("Kode pemulihan salah!");
                }
            });

            loginBtn.addEventListener('click', attemptLogin);
            passwordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') attemptLogin(); });
            usernameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') attemptLogin(); });
        });

        // --- MAIN APP SCRIPT ---
        const initializeApp = () => {
            const { jsPDF } = window.jspdf;

            // --- STATE MANAGEMENT ---
            let state = {
                schoolInfo: { schoolName: '', schoolAddress: '', ksName: '', ksNip: '', teacherName: '', teacherNip: '', tahunAjaran: '' },
                students: [
                    { nis: "1001", name: "Budi Santoso", gender: "L", class: "IV-A" },
                    { nis: "1002", name: "Citra Lestari", gender: "P", class: "IV-B" }
                ],
                subjects: [
                    { name: "Pendidikan Pancasila", kkm: 75 },
                    { name: "B. Indo", kkm: 70 },
                    { name: "Matematika", kkm: 65 },
                    { name: "IPAS", kkm: 70 },
                    { name: "SBDP", kkm: 75 },
                    { name: "B. Inggris", kkm: 70 },
                    { name: "B. Jawa", kkm: 70 },
                    { name: "Koding", kkm: 80 },
                ],
                grades: {
                    semester1: {},
                    semester2: {}
                },
                config: {
                    activePage: 'data-sekolah',
                    activeSubject: "Pendidikan Pancasila",
                    activeSemester: "semester1"
                },
                credentials: {
                    username: 'admin',
                    password: '12345'
                }
            };
            let studentIndexToModify = null;
            let subjectToEdit = null;
            let subjectToDelete = null;

            const saveState = () => localStorage.setItem('nilaiSiswaState', JSON.stringify(state));
            const loadState = () => {
                const savedState = localStorage.getItem('nilaiSiswaState');
                if (savedState) {
                    state = JSON.parse(savedState);
                    if (!state.credentials) {
                        state.credentials = { username: 'admin', password: '12345' };
                    }
                    if (!state.grades || !state.grades.semester1 || !state.grades.semester2) {
                        initializeGrades();
                    }
                } else {
                    initializeGrades();
                }
            };
            
            const initializeGrades = () => {
                state.grades = { semester1: {}, semester2: {} };
                ['semester1', 'semester2'].forEach(semester => {
                    state.subjects.forEach(subject => {
                        state.grades[semester][subject.name] = [];
                        state.students.forEach(student => {
                            state.grades[semester][subject.name].push({ 
                                nis: student.nis, 
                                name: student.name, 
                                summative: [0, 0], 
                                pts: 0, 
                                pas: 0 
                            });
                        });
                    });
                });

                const ppGrades = state.grades.semester1["Pendidikan Pancasila"];
                if (ppGrades && ppGrades.length > 0) {
                    const budiGrade = ppGrades.find(g => g.nis === "1001");
                    if (budiGrade) Object.assign(budiGrade, { summative: [80, 85], pts: 88, pas: 90 });
                    const citraGrade = ppGrades.find(g => g.nis === "1002");
                    if (citraGrade) Object.assign(citraGrade, { summative: [70, 60], pts: 90, pas: 94 });
                }
            };

            // --- NAVIGATION ---
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const pageTitle = document.getElementById('page-title');
            const pageTitles = {
                'data-sekolah': 'Data Sekolah',
                'data-siswa': 'Manajemen Siswa',
                'olah-nilai': 'Olah Nilai',
                'rekap-nilai': 'Rekapitulasi Nilai',
                'pengaturan': 'Pengaturan Akun'
            };

            const navigate = (pageId) => {
                // Close mobile menu if open
                document.getElementById('mobile-menu-dropdown').classList.remove('open');

                state.config.activePage = pageId;
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${pageId}`).classList.add('active');
                
                // Update active state for all nav links
                navLinks.forEach(l => {
                    const linkPage = l.dataset.page;
                    if (linkPage === pageId) {
                        l.classList.add('active', 'text-blue-600', 'bg-blue-50');
                        l.classList.remove('text-gray-600');
                    } else {
                        l.classList.remove('active', 'text-blue-600', 'bg-blue-50');
                        l.classList.add('text-gray-600');
                    }
                });

                // Update mobile header title
                pageTitle.textContent = pageTitles[pageId] || 'E-Nilai';
                
                // Run page-specific render functions
                switch(pageId) {
                    case 'data-sekolah': renderDataSekolah(); break;
                    case 'data-siswa': renderDataSiswa(); break;
                    case 'olah-nilai': renderOlahNilai(); break;
                    case 'rekap-nilai': 
                        renderRekapNilai(); 
                        const today = new Date();
                        document.getElementById('tanggal-cetak').value = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                        document.getElementById('lokasi-cetak').value = "Semarang";
                        break;
                }
                saveState();
            };

            // --- RENDER FUNCTIONS ---
            const renderDataSekolah = () => {
                for (const key in state.schoolInfo) {
                    const inputId = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                    const element = document.getElementById(inputId);
                    if (element) element.value = state.schoolInfo[key];
                }
            };
            const renderDataSiswa = () => {
                const table = document.getElementById('student-list-table');
                table.innerHTML = '';
                const thead = document.createElement('thead');
                thead.className = 'text-xs text-gray-800 uppercase bg-gray-200';
                thead.innerHTML = `<tr>
                    <th class="p-3">No.</th>
                    <th class="p-3">NIS</th>
                    <th class="p-3">Nama Siswa</th>
                    <th class="p-3">Kelas</th>
                    <th class="p-3">L/P</th>
                    <th class="p-3">Aksi</th>
                </tr>`;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                if (state.students.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">Belum ada data siswa.</td></tr>`;
                } else {
                    state.students.forEach((student, index) => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-b hover:bg-gray-50';
                        tr.innerHTML = `
                            <td class="p-3 font-medium">${index + 1}</td>
                            <td class="p-3">${student.nis}</td>
                            <td class="p-3">${student.name}</td>
                            <td class="p-3">${student.class}</td>
                            <td class="p-3">${student.gender}</td>
                            <td class="p-3 text-center">
                                <button class="edit-student-btn text-blue-500 hover:text-blue-700 mr-3" data-index="${index}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="delete-student-btn text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                table.appendChild(tbody);
            };
            const renderOlahNilai = () => {
                document.querySelectorAll('#page-olah-nilai .semester-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.semester === state.config.activeSemester);
                });
                const subjectSelector = document.getElementById('subject-selector');
                const kkmInput = document.getElementById('kkm-input');
                subjectSelector.innerHTML = state.subjects.map(s => `<option value="${s.name}" ${s.name === state.config.activeSubject ? 'selected' : ''}>${s.name}</option>`).join('');
                
                const activeSubjectObj = state.subjects.find(s => s.name === state.config.activeSubject);
                if(activeSubjectObj) {
                    kkmInput.value = activeSubjectObj.kkm;
                } else {
                    kkmInput.value = '';
                }

                renderGradesTable();
            };
            const renderGradesTable = () => {
                const table = document.getElementById('grades-table');
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');
                
                const data = state.grades[state.config.activeSemester][state.config.activeSubject] || [];
                const activeSubjectObj = state.subjects.find(s => s.name === state.config.activeSubject);
                const kkm = activeSubjectObj ? activeSubjectObj.kkm : 0;
                
                thead.innerHTML = '';
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="100%" class="p-4 text-center text-gray-500">Tidak ada data siswa atau mapel.</td></tr>`;
                    return;
                }
                
                const headerRow = document.createElement('tr');
                let headers = [{text: 'No.', class: 'bg-gray-200'}, {text: 'Nama Siswa', class: 'bg-gray-200'}];
                
                // Menampilkan AS (Asesmen Formatif)
                const maxSummative = Math.max(1, ...data.map(s => s.summative.length > 0 ? s.summative.length : 1));
                for (let i = 1; i <= maxSummative; i++) headers.push({text: `AS ${i}`, class: 'bg-yellow-100'});
                
                headers.push({text: 'PTS', class: 'bg-green-100'}, {text: 'PAS', class: 'bg-pink-100'}, {text: 'NA', class: 'bg-gray-200'});
                
                headerRow.innerHTML = headers.map(h => `<th scope="col" class="p-3 ${h.class}">${h.text}</th>`).join('');
                thead.appendChild(headerRow);
                
                data.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.dataset.nis = student.nis;
                    const finalScore = calculateNA(student);
                    const scoreClass = parseFloat(finalScore) < kkm ? 'nilai-merah' : 'text-blue-600';
                    let cells = `<td class="p-3 font-medium">${index + 1}</td><td class="p-3">${student.name}</td>`;
                    
                    // Menampilkan kolom AS (Asesmen Formatif)
                    for (let i = 0; i < maxSummative; i++) {
                        cells += `<td class="p-3 editable bg-yellow-50 hover:bg-yellow-200" contenteditable="true" data-field="summative" data-sub-index="${i}">${student.summative[i] || ''}</td>`;
                    }
                    
                    cells += `<td class="p-3 editable bg-green-50 hover:bg-green-200" contenteditable="true" data-field="pts">${student.pts || ''}</td>`;
                    cells += `<td class="p-3 editable bg-pink-50 hover:bg-pink-200" contenteditable="true" data-field="pas">${student.pas || ''}</td>`;
                    cells += `<td class="p-3 font-bold ${scoreClass}">${finalScore}</td>`;
                    row.innerHTML = cells;
                    tbody.appendChild(row);
                });
            };
            const renderRekapNilai = () => {
                document.querySelectorAll('#page-rekap-nilai .semester-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.semester === state.config.activeSemester);
                });
                const table = document.getElementById('recap-table');
                table.innerHTML = '';
                if (state.students.length === 0) {
                     table.innerHTML = `<tbody><tr><td colspan="5" class="text-center p-4 text-gray-500">Tidak ada data siswa.</td></tr></tbody>`;
                    return;
                }
                const thead = document.createElement('thead');
                thead.className = 'text-xs text-gray-800 uppercase bg-gray-200';
                let headers = ['No.', 'Nama', ...state.subjects.map(s => s.name), 'Rata-Rata'];
                thead.innerHTML = `<tr>${headers.map(h => `<th class="p-3">${h}</th>`).join('')}</tr>`;
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                tbody.className = 'bg-white';
                state.students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    let cells = `<td class="p-3 font-medium">${index + 1}</td><td class="p-3 font-semibold">${student.name}</td>`;
                    let totalScore = 0, subjectCount = 0;
                    state.subjects.forEach(subject => {
                        const studentGrade = state.grades[state.config.activeSemester][subject.name] ? state.grades[state.config.activeSemester][subject.name].find(s => s.nis === student.nis) : null;
                        const finalScore = studentGrade ? parseFloat(calculateNA(studentGrade)) : 0;
                        const scoreClass = finalScore < subject.kkm ? 'nilai-merah' : '';
                        cells += `<td class="p-3 ${scoreClass}">${finalScore.toFixed(2)}</td>`;
                        if (studentGrade) { totalScore += finalScore; subjectCount++; }
                    });
                    const finalAverage = subjectCount > 0 ? (totalScore / subjectCount).toFixed(2) : '0.00';
                    cells += `<td class="p-3 font-bold text-blue-700">${finalAverage}</td>`;
                    row.innerHTML = cells;
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
            };
            const renderSubjectsModal = () => {
                const list = document.getElementById('subjects-list');
                list.innerHTML = '';
                state.subjects.forEach(subject => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between bg-gray-50 p-2 rounded';
                    li.innerHTML = `
                        <span>${subject.name} (KKM: ${subject.kkm})</span>
                        <div>
                            <button class="edit-subject-btn text-blue-500 hover:text-blue-700 mr-3" data-subject="${subject.name}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-subject-btn text-red-500 hover:text-red-700" data-subject="${subject.name}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            };

            // --- CALCULATIONS ---
            const calculateAverage = (arr) => (!arr || arr.length === 0) ? 0 : arr.reduce((acc, val) => acc + (parseFloat(val) || 0), 0) / arr.length;
            const calculateNA = (student) => {
                if (!student) return '0.00';
                const avgSummative = calculateAverage(student.summative);
                const pts = parseFloat(student.pts) || 0;
                const pas = parseFloat(student.pas) || 0;
                const finalScore = (avgSummative + pts + pas) / 3;
                return finalScore.toFixed(2);
            };

            // --- CORE LOGIC ---
            const addStudent = (studentData) => {
                const { nis, name, gender, studentClass } = studentData;
                if (nis && name && studentClass && !state.students.some(s => s.nis === nis)) {
                    state.students.push({ nis, name, gender, class: studentClass });
                    ['semester1', 'semester2'].forEach(semester => {
                        state.subjects.forEach(subject => {
                            if (!state.grades[semester][subject.name]) state.grades[semester][subject.name] = [];
                            const defaultSummative = state.grades[semester][subject.name].length > 0 ? [...state.grades[semester][subject.name][0].summative] : [0];
                            state.grades[semester][subject.name].push({ nis, name, summative: defaultSummative, pts: 0, pas: 0 });
                        });
                    });
                    return true;
                } else if (state.students.some(s => s.nis === nis)) {
                     alert(`Siswa dengan NIS "${nis}" sudah ada.`);
                } else {
                    alert('NIS, Nama, dan Kelas tidak boleh kosong.');
                }
                return false;
            };
            
            const generatePdf = (action) => {
                const doc = new jsPDF();
                const schoolInfo = state.schoolInfo;
                const lokasiCetak = document.getElementById('lokasi-cetak').value || 'Semarang';
                const tanggalCetak = document.getElementById('tanggal-cetak').value || new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const semesterText = state.config.activeSemester === 'semester1' ? 'SEMESTER 1' : 'SEMESTER 2';

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`REKAPITULASI NILAI AKHIR SISWA - ${semesterText}`, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.text(schoolInfo.schoolName.toUpperCase(), doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(schoolInfo.schoolAddress, doc.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
                doc.setFont('helvetica', 'bold');
                doc.text(`TAHUN AJARAN ${schoolInfo.tahunAjaran || ''}`, doc.internal.pageSize.getWidth() / 2, 34, { align: 'center' });
                
                doc.autoTable({
                    html: '#recap-table',
                    startY: 40,
                    theme: 'grid',
                    headStyles: { fillColor: [22, 160, 133], textColor: [255, 255, 255], halign: 'center' },
                    styles: { fontSize: 8, cellPadding: 2 },
                    didParseCell: function (data) {
                        if (data.cell.text[0] && data.cell.text[0].classList && data.cell.text[0].classList.contains('nilai-merah')) {
                            data.cell.styles.textColor = [255, 0, 0];
                        }
                    }
                });

                const finalY = doc.autoTable.previous.finalY;
                doc.setFontSize(10);
                doc.text(`${lokasiCetak}, ${tanggalCetak}`, doc.internal.pageSize.getWidth() - 20, finalY + 20, { align: 'right' });
                doc.text('Guru Kelas,', doc.internal.pageSize.getWidth() - 20, finalY + 25, { align: 'right' });
                doc.text(schoolInfo.teacherName || '(___________________)', doc.internal.pageSize.getWidth() - 20, finalY + 45, { align: 'right' });
                doc.text(`NIP. ${schoolInfo.teacherNip || ' '}`, doc.internal.pageSize.getWidth() - 20, finalY + 50, { align: 'right' });

                if (action === 'preview') {
                    doc.output('dataurlnewwindow');
                } else {
                    doc.save(`rekap-nilai-${state.config.activeSemester}.pdf`);
                }
            };

            const generateXlsx = () => {
                const ws = XLSX.utils.table_to_sheet(document.getElementById('recap-table'));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Rekap Nilai');
                XLSX.writeFile(wb, `rekap-nilai-${state.config.activeSemester}.xlsx`);
            };


            // --- EVENT HANDLERS ---
            navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigate(e.currentTarget.dataset.page); }));
            
            // Mobile Menu Toggle
            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                document.getElementById('mobile-menu-dropdown').classList.toggle('open');
            });

            document.getElementById('save-school-data').addEventListener('click', () => {
                for (const key in state.schoolInfo) {
                    const inputId = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                    state.schoolInfo[key] = document.getElementById(inputId).value;
                }
                alert('Data sekolah berhasil disimpan!');
                saveState();
            });
            document.getElementById('add-student-btn').addEventListener('click', () => {
                const nisInput = document.getElementById('new-student-nis');
                const nameInput = document.getElementById('new-student-name');
                const classInput = document.getElementById('new-student-class');
                const genderInput = document.querySelector('input[name="new-student-gender"]:checked');
                const studentData = {
                    nis: nisInput.value.trim(),
                    name: nameInput.value.trim(),
                    gender: genderInput.value,
                    studentClass: classInput.value.trim()
                };
                if (addStudent(studentData)) {
                    nisInput.value = ''; nameInput.value = ''; classInput.value = '';
                    renderDataSiswa();
                    saveState();
                }
            });
            
            // --- Modal Handlers ---
            const setupModal = (modalId, openCallback, saveCallback, cancelCallback) => {
                const modal = document.getElementById(modalId);
                if (!modal) return;

                const confirmBtn = modal.querySelector('.confirm-btn');
                const saveBtn = modal.querySelector('.save-btn');
                const cancelBtn = modal.querySelector('.cancel-btn');

                if (confirmBtn) confirmBtn.addEventListener('click', saveCallback);
                if (saveBtn) saveBtn.addEventListener('click', saveCallback);
                if (cancelBtn) cancelBtn.addEventListener('click', () => {
                    modal.classList.remove('active');
                    if (cancelCallback) cancelCallback();
                });
            };

            const openModal = (modalId) => document.getElementById(modalId).classList.add('active');
            const closeModal = (modalId) => document.getElementById(modalId).classList.remove('active');

            // Delete Student Modal
            document.getElementById('student-list-table').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                studentIndexToModify = parseInt(target.dataset.index);
                const student = state.students[studentIndexToModify];
                if (target.classList.contains('delete-student-btn')) {
                    document.getElementById('delete-student-name').textContent = student.name;
                    openModal('delete-modal');
                } else if (target.classList.contains('edit-student-btn')) {
                    document.getElementById('edit-student-nis').value = student.nis;
                    document.getElementById('edit-student-name').value = student.name;
                    document.getElementById('edit-student-class').value = student.class;
                    document.querySelector(`input[name="edit-student-gender"][value="${student.gender}"]`).checked = true;
                    openModal('edit-modal');
                    document.getElementById('edit-student-name').focus();
                }
            });
            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                const student = state.students[studentIndexToModify];
                state.students.splice(studentIndexToModify, 1);
                ['semester1', 'semester2'].forEach(semester => {
                    Object.keys(state.grades[semester]).forEach(subject => {
                        state.grades[semester][subject] = state.grades[semester][subject].filter(s => s.nis !== student.nis);
                    });
                });
                renderDataSiswa();
                saveState();
                closeModal('delete-modal');
                studentIndexToModify = null;
            });
            document.getElementById('cancel-delete-btn').addEventListener('click', () => closeModal('delete-modal'));
            
            // Edit Student Modal
            document.getElementById('save-edit-btn').addEventListener('click', () => {
                const newName = document.getElementById('edit-student-name').value.trim();
                const newClass = document.getElementById('edit-student-class').value.trim();
                const newGender = document.querySelector('input[name="edit-student-gender"]:checked').value;
                if (newName && newClass) {
                    const student = state.students[studentIndexToModify];
                    student.name = newName; student.class = newClass; student.gender = newGender;
                    ['semester1', 'semester2'].forEach(semester => {
                       Object.keys(state.grades[semester]).forEach(subject => {
                           const studentGrade = state.grades[semester][subject].find(s => s.nis === student.nis);
                           if(studentGrade) studentGrade.name = newName;
                       });
                    });
                    renderDataSiswa();
                    saveState();
                    closeModal('edit-modal');
                    studentIndexToModify = null;
                } else alert('Nama dan Kelas tidak boleh kosong.');
            });
            document.getElementById('cancel-edit-btn').addEventListener('click', () => closeModal('edit-modal'));

            // --- Subjects Modals ---
            document.getElementById('edit-subjects-btn').addEventListener('click', () => {
                renderSubjectsModal();
                openModal('subjects-modal');
            });
            document.getElementById('close-subjects-modal-btn').addEventListener('click', () => closeModal('subjects-modal'));
            document.getElementById('add-subject-btn').addEventListener('click', () => {
                const inputName = document.getElementById('new-subject-name');
                const inputKkm = document.getElementById('new-subject-kkm');
                const newSubjectName = inputName.value.trim();
                const newSubjectKkm = parseInt(inputKkm.value) || 0;
                if (newSubjectName && !state.subjects.some(s => s.name === newSubjectName)) {
                    state.subjects.push({ name: newSubjectName, kkm: newSubjectKkm });
                    ['semester1', 'semester2'].forEach(semester => {
                        state.grades[semester][newSubjectName] = [];
                        state.students.forEach(student => {
                            state.grades[semester][newSubjectName].push({ nis: student.nis, name: student.name, summative: [0], pts: 0, pas: 0 });
                        });
                    });
                    inputName.value = ''; inputKkm.value = '';
                    renderSubjectsModal(); renderOlahNilai(); saveState();
                } else alert('Mapel tidak boleh kosong atau sudah ada.');
            });
             document.getElementById('subjects-list').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const subjectName = target.dataset.subject;
                if (target.classList.contains('delete-subject-btn')) {
                    subjectToDelete = subjectName;
                    document.getElementById('delete-subject-name').textContent = subjectName;
                    openModal('delete-subject-modal');
                } else if (target.classList.contains('edit-subject-btn')) {
                    subjectToEdit = state.subjects.find(s => s.name === subjectName);
                    if (subjectToEdit) {
                        document.getElementById('edit-subject-input').value = subjectToEdit.name;
                        document.getElementById('edit-subject-kkm').value = subjectToEdit.kkm;
                        openModal('edit-subject-modal');
                    }
                }
            });
            document.getElementById('save-edit-subject-btn').addEventListener('click', () => {
                const newName = document.getElementById('edit-subject-input').value.trim();
                const newKkm = parseInt(document.getElementById('edit-subject-kkm').value) || 0;
                const isNameUnique = !state.subjects.some(s => s.name === newName && s.name !== subjectToEdit.name);
                if (newName && isNameUnique) {
                    const oldName = subjectToEdit.name;
                    subjectToEdit.name = newName; subjectToEdit.kkm = newKkm;
                    if (oldName !== newName) {
                        ['semester1', 'semester2'].forEach(semester => {
                            state.grades[semester][newName] = state.grades[semester][oldName];
                            delete state.grades[semester][oldName];
                        });
                    }
                    if (state.config.activeSubject === oldName) state.config.activeSubject = newName;
                    renderSubjectsModal(); renderOlahNilai(); saveState();
                    closeModal('edit-subject-modal'); subjectToEdit = null;
                } else alert('Nama mapel tidak boleh kosong atau sudah ada.');
            });
            document.getElementById('cancel-edit-subject-btn').addEventListener('click', () => closeModal('edit-subject-modal'));
            document.getElementById('confirm-delete-subject-btn').addEventListener('click', () => {
                state.subjects = state.subjects.filter(s => s.name !== subjectToDelete);
                ['semester1', 'semester2'].forEach(semester => delete state.grades[semester][subjectToDelete]);
                if (state.config.activeSubject === subjectToDelete) state.config.activeSubject = state.subjects.length > 0 ? state.subjects[0].name : null;
                renderSubjectsModal(); renderOlahNilai(); saveState();
                closeModal('delete-subject-modal'); subjectToDelete = null;
            });
            document.getElementById('cancel-delete-subject-btn').addEventListener('click', () => closeModal('delete-subject-modal'));

            // --- Semester Tab Handlers ---
            document.querySelectorAll('.semester-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    state.config.activeSemester = e.target.dataset.semester;
                    if (state.config.activePage === 'olah-nilai') renderOlahNilai();
                    else if (state.config.activePage === 'rekap-nilai') renderRekapNilai();
                    saveState();
                });
            });

            // --- Other Handlers ---
            document.getElementById('upload-excel').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        let count = 0;
                        json.forEach((row, rowIndex) => {
                            if (rowIndex >= 0 && row[0] && row[1] && row[2] && row[3]) {
                                if (addStudent({
                                    nis: row[0].toString().trim(), name: row[1].toString().trim(),
                                    studentClass: row[2].toString().trim(), gender: row[3].toString().trim().toUpperCase()
                                })) count++;
                            }
                        });
                        renderDataSiswa(); saveState();
                        alert(`${count} siswa baru berhasil ditambahkan.`);
                    } catch (error) {
                        alert('Gagal memproses file. Pastikan format file Excel sudah benar.');
                        console.error("Excel processing error:", error);
                    }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = '';
            });
            document.getElementById('subject-selector').addEventListener('change', (e) => {
                state.config.activeSubject = e.target.value;
                renderOlahNilai(); saveState();
            });
            document.getElementById('kkm-input').addEventListener('change', (e) => {
                const activeSubjectObj = state.subjects.find(s => s.name === state.config.activeSubject);
                if (activeSubjectObj) {
                    activeSubjectObj.kkm = parseInt(e.target.value) || 0;
                    renderGradesTable(); saveState();
                }
            });
            document.getElementById('add-summative-btn').addEventListener('click', () => {
                 const grades = state.grades[state.config.activeSemester][state.config.activeSubject];
                 if (grades) { grades.forEach(s => s.summative.push(0)); renderGradesTable(); saveState(); }
            });
            document.getElementById('delete-summative-btn').addEventListener('click', () => {
                const grades = state.grades[state.config.activeSemester][state.config.activeSubject];
                if (grades && grades.length > 0 && grades[0].summative.length > 1) {
                    grades.forEach(s => s.summative.pop()); renderGradesTable(); saveState();
                } else alert('Tidak dapat menghapus kolom AS terakhir.');
            });
            document.getElementById('grades-table').addEventListener('focusout', (e) => {
                if (e.target.classList.contains('editable')) {
                    const cell = e.target;
                    const studentNis = cell.parentElement.dataset.nis;
                    const field = cell.dataset.field;
                    const subIndex = cell.dataset.subIndex;
                    const newValue = cell.textContent;
                    const student = state.grades[state.config.activeSemester][state.config.activeSubject].find(s => s.nis === studentNis);
                    if (!student) return;
                    
                    if (field === 'pts' || field === 'pas') student[field] = parseFloat(newValue) || 0;
                    else if (field === 'summative') student[field][subIndex] = parseFloat(newValue) || 0;
                    
                    renderGradesTable(); // Re-render to update all colors
                    saveState();
                }
            });
            document.getElementById('grades-table').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('editable')) { e.preventDefault(); e.target.blur(); }
            });
            
            // PDF & XLSX Handlers
            document.getElementById('preview-pdf-btn').addEventListener('click', () => generatePdf('preview'));
            document.getElementById('download-pdf-btn').addEventListener('click', () => generatePdf('download'));
            document.getElementById('download-excel-btn').addEventListener('click', generateXlsx);

            // Settings Handler
            document.getElementById('save-settings-btn').addEventListener('click', () => {
                const currentPassword = document.getElementById('current-password').value;
                const newUsername = document.getElementById('new-username').value.trim();
                const newPassword = document.getElementById('new-password').value;
                const messageEl = document.getElementById('settings-message');
                if (currentPassword !== state.credentials.password) {
                    messageEl.textContent = 'Password saat ini salah!';
                    messageEl.className = 'text-sm text-center text-red-500';
                    return;
                }
                if (newUsername) state.credentials.username = newUsername;
                if (newPassword) state.credentials.password = newPassword;
                saveState();
                messageEl.textContent = 'Pengaturan berhasil disimpan!';
                messageEl.className = 'text-sm text-center text-green-500';
                document.getElementById('current-password').value = '';
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                setTimeout(() => { messageEl.textContent = '' }, 3000);
            });

            // Logout Handlers
            const logout = () => window.location.reload();
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('logout-btn-mobile').addEventListener('click', logout);

            // Initial Load
            loadState();
            navigate(state.config.activePage);
        };
    </script>
</body>
</html>
